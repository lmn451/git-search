<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        position: relative;
      }

      #searchQuery {
        width: 60%;
        padding: 8px;
        margin: 8px;
      }

      #searchBtn,
      #loadMoreBtn,
      #resetBtn {
        padding: 8px 15px;
        margin: 5px;
      }

      #results {
        margin-top: 20px;
      }

      .commit {
        padding: 10px;
        border-bottom: 1px solid #ccc;
      }

      .commit a {
        text-decoration: none;
        color: blue;
      }
      .commit-diff {
        margin: 20px auto;
      }
      .find-widget {
        position: fixed;
        top: 60px;
        right: 20px;
      }
      .highlight {
        background-color: yellow;
      }
      .current-highlight {
        background-color: orange;
      }
      .search-container {
        width: 100%;
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
      }
    </style>
    <title>Git Search</title>
  </head>

  <body>
    <div class="search-container">
      <input
        autofocus
        type="text"
        id="searchQuery"
        placeholder="Enter search query (regexp friendly)"
      />
      <button id="searchBtn">Search</button>
      <button id="resetBtn">Reset</button>
    </div>
    <div id="findWidget" class="find-widget">
      <input type="text" id="findInput" placeholder="Find" />
      <span id="matchCount"></span>
      <button id="findPrev">Previous</button>
      <button id="findNext">Next</button>
    </div>
    <script></script>
    <div id="results"></div>
    <button id="loadMoreBtn" style="display: none">Load More</button>

    <script>
      //Search Logic
      const vscode = acquireVsCodeApi();
      document.getElementById("searchBtn").addEventListener("click", () => {
        const query = document.getElementById("searchQuery").value;
        vscode.postMessage({ command: "search", text: query });
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        document.getElementById("searchQuery").value = "";
        vscode.postMessage({ command: "reset" });
      });

      document.getElementById("loadMoreBtn").addEventListener("click", () => {
        vscode.postMessage({ command: "loadMore", text: "" });
      });

      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "showResults":
            document.getElementById("results").innerHTML =
              message.text || "No results found";
            document.getElementById("loadMoreBtn").style.display = message.text
              ? "block"
              : "none";
            break;
          case "appendResults":
            document.getElementById("loadMoreBtn").style.display = message.text
              ? "block"
              : "none";
            document.getElementById("results").innerHTML +=
              message.text || "Nothing More";
            break;

          case "reset":
            document.getElementById("results").innerHTML = "";
            document.getElementById("loadMoreBtn").style.display = "none";
            document.getElementById("findInput").value = "";
            document.getElementById("matchCount").innerHTML = "";
            break;
        }
      });
      // Find Logic
      const findInput = document.getElementById("findInput");
      const findPrevButton = document.getElementById("findPrev");
      const findNextButton = document.getElementById("findNext");
      let findMatches = [];
      let currentFindIndex = -1;

      findInput.addEventListener("input", () =>
        searchAndHighlight(findInput.value)
      );

      findPrevButton.addEventListener("click", () => navigateFind("prev"));
      findNextButton.addEventListener("click", () => navigateFind("next"));

      function searchAndHighlight(query) {
        resetHighlights();
        findMatches = [];
        currentFindIndex = -1;
        if (!query) {
          updateMatchCount(0, 0); // Reset counter when query is empty
          return;
        }

        const regex = new RegExp(escapeRegExp(query), "gi");
        document.querySelectorAll(".commit-diff").forEach((commitElem) => {
          processNode(commitElem, regex);
        });

        if (findMatches.length > 0) {
          currentFindIndex = 0;
          navigateFind("next");
        } else {
          updateMatchCount(0, 0);
        }
      }

      function processNode(node, regex) {
        if (node.nodeType === Node.TEXT_NODE) {
          const text = node.textContent;
          const parent = node.parentNode;
          const docFrag = document.createDocumentFragment();

          let startIndex = 0,
            match;
          while ((match = regex.exec(text)) !== null) {
            docFrag.appendChild(
              document.createTextNode(text.substring(startIndex, match.index))
            );

            const highlightSpan = document.createElement("span");
            highlightSpan.className = "highlight";
            highlightSpan.textContent = match[0];
            docFrag.appendChild(highlightSpan);
            findMatches.push(highlightSpan);

            startIndex = match.index + match[0].length;
          }
          docFrag.appendChild(
            document.createTextNode(text.substring(startIndex))
          );

          if (startIndex > 0) {
            parent.replaceChild(docFrag, node);
          }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          Array.from(node.childNodes).forEach((child) =>
            processNode(child, regex)
          );
        }
      }

      function navigateFind(direction) {
        if (findMatches.length === 0) return;
        if (currentFindIndex !== -1) {
          findMatches[currentFindIndex].classList.remove("current-highlight");
        }
        if (direction === "next") {
          currentFindIndex = (currentFindIndex + 1) % findMatches.length;
        } else if (direction === "prev") {
          currentFindIndex =
            (currentFindIndex - 1 + findMatches.length) % findMatches.length;
        }
        findMatches[currentFindIndex].classList.add("current-highlight");
        findMatches[currentFindIndex].scrollIntoView({
          behavior: "smooth",
          block: "center",
        });
        updateMatchCount(currentFindIndex + 1, findMatches.length);
      }

      function updateMatchCount(currentIndex, totalMatches) {
        matchCount.textContent =
          totalMatches > 0 ? `${currentIndex} of ${totalMatches}` : "";
      }

      function resetHighlights() {
        document.querySelectorAll(".highlight").forEach((highlightSpan) => {
          const textNode = document.createTextNode(highlightSpan.textContent);
          const parent = highlightSpan.parentNode;
          parent.replaceChild(textNode, highlightSpan);
          parent.normalize(); // Normalize merges adjacent text nodes
        });
        findMatches = [];
        currentFindIndex = -1;
      }

      function escapeRegExp(text) {
        return text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }
    </script>
  </body>
</html>
